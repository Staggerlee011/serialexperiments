<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>serialexperiments - DevOps</title><link href="/" rel="alternate"></link><link href="/feeds/devops.atom.xml" rel="self"></link><id>/</id><updated>2020-12-04T00:00:00+00:00</updated><entry><title>Terraform remote statefile creation</title><link href="/terraform-remote-statefile-creation.html" rel="alternate"></link><published>2020-12-04T00:00:00+00:00</published><updated>2020-12-04T00:00:00+00:00</updated><author><name>staggerlee011</name></author><id>tag:None,2020-12-04:/terraform-remote-statefile-creation.html</id><summary type="html">&lt;p&gt;Terraform code to generate a secure s3 bucket for remote state&lt;/p&gt;</summary><content type="html">&lt;p&gt;When you deploy Terraform you'll want to have a remote state setup to manage team access. For AWS the standard is to use S3 bucket. As you cant store the state of bucket IN the bucket, its one of the only things that you have to leave outside of being controlled via the remote state.&lt;/p&gt;
&lt;p&gt;For our teams we manage this via still creating the s3 bucket in Terraform and keep the code in source control, this is normally stored in a &lt;code&gt;.state&lt;/code&gt; folder along with the other workspaces.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="p"&gt;-&lt;/span&gt; &lt;span class="n"&gt;terraform&lt;/span&gt;
  &lt;span class="p"&gt;-&lt;/span&gt; &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;state&lt;/span&gt;
  &lt;span class="p"&gt;-&lt;/span&gt; &lt;span class="n"&gt;core&lt;/span&gt;
  &lt;span class="p"&gt;-&lt;/span&gt; &lt;span class="n"&gt;eks&lt;/span&gt;
  &lt;span class="p"&gt;-&lt;/span&gt; &lt;span class="n"&gt;rds&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The below is a gist example of the code we use, id suggest also adding a &lt;code&gt;version.tf&lt;/code&gt; in the folder that matches the rest of your workspaces.&lt;/p&gt;
&lt;div class="gist"&gt;
    &lt;script src='https://gist.github.com/b08b80dad659cd549030e5855a798673.js?file=terraform-statefile-bucket.tf'&gt;&lt;/script&gt;
    &lt;noscript&gt;
        &lt;pre&gt;&lt;code&gt;provider "aws" {
    region = "eu-west-2"
    profile = "xxx"
}

variable "env" {
    description = "Name of AWS environment"
    type = string
    default = "xxx"
}

resource "aws_s3_bucket" "terraform_state" {
    bucket = "${var.env}-statefile"

    # Enable versioning
    versioning {
        enabled = true
    }

    #Enable Server Side Encryption by default
    server_side_encryption_configuration {
        rule {
            apply_server_side_encryption_by_default {
                sse_algorithm = "AES256"
            }
        }
    }

}

# Block ALL public access to statefile bucket
resource "aws_s3_bucket_public_access_block" "terraform_state" {
  bucket = aws_s3_bucket.terraform_state.id

  block_public_acls         = true
  block_public_policy       = true
  ignore_public_acls        = true
  restrict_public_buckets   = true
}&lt;/code&gt;&lt;/pre&gt;
    &lt;/noscript&gt;
&lt;/div&gt;</content><category term="DevOps"></category><category term="terraform"></category><category term="gist"></category></entry></feed>